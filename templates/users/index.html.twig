{% extends 'base.html.twig' %}

{% block title %}Users Management - Symfony 7 App{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .user-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .user-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff, #0056b3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: bold;
    }
    .role-badge {
        font-size: 0.75rem;
    }
    .search-box {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .stats-card {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .filter-btn {
        margin-right: 5px;
        margin-bottom: 5px;
    }
    .table-responsive {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .user-status {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .status-active { background-color: #28a745; }
    .status-inactive { background-color: #dc3545; }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold mb-2">
                        <i class="bi bi-people-fill text-primary me-3"></i>Users Management
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ path('app_home') }}">Home</a></li>
                            <li class="breadcrumb-item"><a href="{{ path('app_dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Users</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a href="{{ path('app_dashboard') }}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                    </a>
                    {% if is_granted('ROLE_ADMIN') %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                            <i class="bi bi-person-plus me-2"></i>Add User
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card text-center">
                <i class="bi bi-people fs-1 mb-2"></i>
                <h3 class="mb-1">{{ stats.total_users }}</h3>
                <p class="mb-0">Total Users</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white;">
                <div class="card-body">
                    <i class="bi bi-person-check fs-1 mb-2"></i>
                    <h3 class="mb-1">{{ stats.active_users }}</h3>
                    <p class="mb-0">Active Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: white;">
                <div class="card-body">
                    <i class="bi bi-shield-check fs-1 mb-2"></i>
                    <h3 class="mb-1">{{ stats.admin_users }}</h3>
                    <p class="mb-0">Administrators</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white;">
                <div class="card-body">
                    <i class="bi bi-calendar-plus fs-1 mb-2"></i>
                    <h3 class="mb-1">{{ stats.recent_users }}</h3>
                    <p class="mb-0">This Month</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="search-box">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search users by name, email, or username...">
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-end flex-wrap">
                    <button class="btn btn-outline-secondary filter-btn" onclick="filterUsers('all')" id="filter-all">
                        <i class="bi bi-people me-1"></i>All
                    </button>
                    <button class="btn btn-outline-success filter-btn" onclick="filterUsers('active')" id="filter-active">
                        <i class="bi bi-person-check me-1"></i>Active
                    </button>
                    <button class="btn btn-outline-danger filter-btn" onclick="filterUsers('inactive')" id="filter-inactive">
                        <i class="bi bi-person-x me-1"></i>Inactive
                    </button>
                    <button class="btn btn-outline-warning filter-btn" onclick="filterUsers('admin')" id="filter-admin">
                        <i class="bi bi-shield-check me-1"></i>Admins
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Toggle -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group" aria-label="View toggle">
                <button type="button" class="btn btn-outline-primary active" id="cardView" onclick="toggleView('card')">
                    <i class="bi bi-grid-3x3-gap me-1"></i>Card View
                </button>
                <button type="button" class="btn btn-outline-primary" id="tableView" onclick="toggleView('table')">
                    <i class="bi bi-table me-1"></i>Table View
                </button>
            </div>
        </div>
    </div>

    <!-- Users Display -->
    <div id="usersContainer">
        <!-- Card View -->
        <div id="cardViewContainer">
            <div class="row" id="usersCardContainer">
                {% for user in users %}
                <div class="col-md-6 col-lg-4 mb-4 user-item" 
                     data-user-id="{{ user.id }}"
                     data-user-email="{{ user.email|lower }}"
                     data-user-name="{{ (user.firstName ~ ' ' ~ user.lastName)|lower }}"
                     data-user-username="{{ user.username|lower }}"
                     data-user-status="{{ user.isActive ? 'active' : 'inactive' }}"
                     data-user-roles="{{ user.roles|join(',')|lower }}">
                    <div class="card user-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="user-avatar me-3">
                                    {{ (user.firstName ?? user.username ?? user.email)|slice(0,1)|upper }}
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="card-title mb-1">
                                        {{ user.fullName ?: user.username }}
                                        <span class="user-status {{ user.isActive ? 'status-active' : 'status-inactive' }}"></span>
                                    </h5>
                                    <p class="card-text text-muted small mb-0">{{ user.email }}</p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                {% for role in user.roles %}
                                    <span class="badge bg-{{ role == 'ROLE_ADMIN' ? 'danger' : (role == 'ROLE_USER' ? 'primary' : 'secondary') }} role-badge me-1">
                                        {{ role|replace({'ROLE_': ''})|title }}
                                    </span>
                                {% endfor %}
                            </div>
                            
                            <div class="small text-muted mb-3">
                                <div><i class="bi bi-person me-1"></i>Username: {{ user.username }}</div>
                                <div><i class="bi bi-calendar me-1"></i>Joined: {{ user.createdAt ? user.createdAt|date('M d, Y') : 'Unknown' }}</div>
                                <div>
                                    <i class="bi bi-{{ user.isActive ? 'check-circle-fill text-success' : 'x-circle-fill text-danger' }} me-1"></i>
                                    Status: {{ user.isActive ? 'Active' : 'Inactive' }}
                                </div>
                            </div>
                            
                            {% if is_granted('ROLE_ADMIN') %}
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewUser({{ user.id }})">
                                        <i class="bi bi-eye me-1"></i>View
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="editUser({{ user.id }})">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                    {% if user.id != app.user.id %}
                                        <button class="btn btn-sm btn-outline-{{ user.isActive ? 'warning' : 'success' }}" 
                                                onclick="toggleUserStatus({{ user.id }}, {{ user.isActive ? 'false' : 'true' }})">
                                            <i class="bi bi-{{ user.isActive ? 'pause' : 'play' }} me-1"></i>
                                            {{ user.isActive ? 'Deactivate' : 'Activate' }}
                                        </button>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Table View -->
        <div id="tableViewContainer" style="display: none;">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th><i class="bi bi-person me-1"></i>User</th>
                            <th><i class="bi bi-envelope me-1"></i>Email</th>
                            <th><i class="bi bi-shield me-1"></i>Roles</th>
                            <th><i class="bi bi-activity me-1"></i>Status</th>
                            <th><i class="bi bi-calendar me-1"></i>Joined</th>
                            {% if is_granted('ROLE_ADMIN') %}
                                <th><i class="bi bi-gear me-1"></i>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        {% for user in users %}
                        <tr class="user-item"
                            data-user-id="{{ user.id }}"
                            data-user-email="{{ user.email|lower }}"
                            data-user-name="{{ (user.firstName ~ ' ' ~ user.lastName)|lower }}"
                            data-user-username="{{ user.username|lower }}"
                            data-user-status="{{ user.isActive ? 'active' : 'inactive' }}"
                            data-user-roles="{{ user.roles|join(',')|lower }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar me-3" style="width: 40px; height: 40px; font-size: 16px;">
                                        {{ (user.firstName ?? user.username ?? user.email)|slice(0,1)|upper }}
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ user.fullName ?: user.username }}</div>
                                        <small class="text-muted">@{{ user.username }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% for role in user.roles %}
                                    <span class="badge bg-{{ role == 'ROLE_ADMIN' ? 'danger' : (role == 'ROLE_USER' ? 'primary' : 'secondary') }} role-badge me-1">
                                        {{ role|replace({'ROLE_': ''})|title }}
                                    </span>
                                {% endfor %}
                            </td>
                            <td>
                                <span class="badge bg-{{ user.isActive ? 'success' : 'danger' }}">
                                    <i class="bi bi-{{ user.isActive ? 'check-circle' : 'x-circle' }} me-1"></i>
                                    {{ user.isActive ? 'Active' : 'Inactive' }}
                                </span>
                            </td>
                            <td>{{ user.createdAt ? user.createdAt|date('M d, Y') : 'Unknown' }}</td>
                            {% if is_granted('ROLE_ADMIN') %}
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewUser({{ user.id }})">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="editUser({{ user.id }})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        {% if user.id != app.user.id %}
                                            <button class="btn btn-outline-{{ user.isActive ? 'warning' : 'success' }}" 
                                                    onclick="toggleUserStatus({{ user.id }}, {{ user.isActive ? 'false' : 'true' }})">
                                                <i class="bi bi-{{ user.isActive ? 'pause' : 'play' }}"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" style="display: none;">
        <div class="text-center py-5">
            <i class="bi bi-people display-1 text-muted"></i>
            <h3 class="mt-3">No users found</h3>
            <p class="text-muted">Try adjusting your search criteria or filters.</p>
        </div>
    </div>
</div>

<!-- Create User Modal (Admin only) -->
{% if is_granted('ROLE_ADMIN') %}
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="newEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="newUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="newUsername" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newFirstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="newFirstName">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newLastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="newLastName">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newRoles" class="form-label">Roles</label>
                        <select multiple class="form-select" id="newRoles">
                            <option value="ROLE_USER" selected>User</option>
                            <option value="ROLE_ADMIN">Administrator</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block javascripts %}
<script>
let currentFilter = 'all';
let currentView = 'card';

document.addEventListener('DOMContentLoaded', function() {
    // Initialize search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
        filterUsers(currentFilter, e.target.value);
    });
    
    // Set initial filter button state
    document.getElementById('filter-all').classList.add('active');
    
    console.log('Users list loaded with {{ users|length }} users');
});

function filterUsers(filter, searchTerm = '') {
    currentFilter = filter;
    const searchInput = document.getElementById('searchInput');
    if (searchTerm === '') {
        searchTerm = searchInput.value.toLowerCase();
    }
    
    // Update filter button states
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('filter-' + filter).classList.add('active');
    
    const userItems = document.querySelectorAll('.user-item');
    let visibleCount = 0;
    
    userItems.forEach(item => {
        const email = item.dataset.userEmail || '';
        const name = item.dataset.userName || '';
        const username = item.dataset.userUsername || '';
        const status = item.dataset.userStatus || '';
        const roles = item.dataset.userRoles || '';
        
        // Search filter
        const matchesSearch = searchTerm === '' || 
            email.includes(searchTerm) ||
            name.includes(searchTerm) ||
            username.includes(searchTerm);
        
        // Status filter
        let matchesFilter = true;
        switch(filter) {
            case 'active':
                matchesFilter = status === 'active';
                break;
            case 'inactive':
                matchesFilter = status === 'inactive';
                break;
            case 'admin':
                matchesFilter = roles.includes('role_admin');
                break;
            case 'all':
            default:
                matchesFilter = true;
                break;
        }
        
        if (matchesSearch && matchesFilter) {
            item.style.display = '';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Show/hide empty state
    const emptyState = document.getElementById('emptyState');
    const usersContainer = document.getElementById('usersContainer');
    
    if (visibleCount === 0) {
        emptyState.style.display = 'block';
        usersContainer.style.display = 'none';
    } else {
        emptyState.style.display = 'none';
        usersContainer.style.display = 'block';
    }
}

function toggleView(view) {
    currentView = view;
    
    // Update button states
    document.getElementById('cardView').classList.toggle('active', view === 'card');
    document.getElementById('tableView').classList.toggle('active', view === 'table');
    
    // Show/hide containers
    document.getElementById('cardViewContainer').style.display = view === 'card' ? 'block' : 'none';
    document.getElementById('tableViewContainer').style.display = view === 'table' ? 'block' : 'none';
}

function viewUser(userId) {
    // For now, show user details in alert. In production, this would open a modal or navigate to user detail page
    alert('View user details for user ID: ' + userId + '\n\nThis would normally open a detailed user profile page.');
}

function editUser(userId) {
    // For now, show edit form in alert. In production, this would open an edit modal or form
    alert('Edit user with ID: ' + userId + '\n\nThis would normally open an editable user form.');
}

function toggleUserStatus(userId, newStatus) {
    if (confirm('Are you sure you want to ' + (newStatus === 'true' ? 'activate' : 'deactivate') + ' this user?')) {
        // In production, this would make an API call to update user status
        alert('User status would be updated to: ' + (newStatus === 'true' ? 'Active' : 'Inactive') + '\n\nPage would then refresh to show updated status.');
        // location.reload(); // Uncomment when API is implemented
    }
}

function createUser() {
    const form = document.getElementById('createUserForm');
    const formData = new FormData(form);
    
    // Basic form validation
    const email = document.getElementById('newEmail').value;
    const username = document.getElementById('newUsername').value;
    const password = document.getElementById('newPassword').value;
    
    if (!email || !username || !password) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // In production, this would make an API call to create the user
    alert('User creation functionality would be implemented here.\n\nThis would make an API call to create a new user with the provided details.');
    
    // Close modal and reset form
    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
    form.reset();
}

// Add some nice animations
function animateCards() {
    const cards = document.querySelectorAll('.user-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.transform = 'translateY(0)';
            card.style.opacity = '1';
        }, index * 100);
    });
}

// Initialize animations on load
window.addEventListener('load', animateCards);
</script>
{% endblock %}
